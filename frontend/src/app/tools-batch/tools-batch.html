<div class="container">
    <header>
        <h1>Creaci√≥n M√∫ltiple / Importador</h1>
        <p>Define una configuraci√≥n base y a√±ade m√∫ltiples endpoints manualmente o importando un OpenAPI/Swagger.</p>
    </header>

    <main>
        <div class="tabs">
            <a routerLink="/tools" class="tab">Una a la vez</a>
            <a routerLink="/tools/batch" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}"
                class="tab active">M√∫ltiples / Importar</a>
        </div>

        <div class="card form-card">
            <form [formGroup]="batchForm" (ngSubmit)="onSubmit()">

                <!-- OpenAPI & HandsAI Importer Section -->
                <div class="form-group full-width import-section">
                    <label for="openapi-json">Importador R√°pido (HandsAI JSON u OpenAPI)</label>
                    <p class="helper-text">Pega el JSON exportado directamente de otro agente HandsAI, o usa un Swagger
                        2.0 / OpenAPI 3.x y procesaremos las rutas por ti.</p>
                    <textarea id="openapi-json" [(ngModel)]="openApiJsonText" [ngModelOptions]="{standalone: true}"
                        rows="4" style="resize: vertical; min-height: 100px;"
                        placeholder='[ { "name": "API", "tools": [...] } ]   o   { "openapi": "3.0.0", "paths": { ... } }'></textarea>
                    <button type="button" class="btn secondary" (click)="importOpenApi()" style="margin-top: 0.5rem;">
                        Procesar JSON
                    </button>
                    <div *ngIf="importError" class="error-msg">{{ importError }}</div>
                    <div *ngIf="importSuccessMessage" class="success-msg">{{ importSuccessMessage }}</div>
                </div>

                <div class="form-grid">
                    <div class="form-group full-width section-title">
                        <h3>1. Configuraci√≥n del Proveedor (Base)</h3>
                        <div class="checkbox-group" style="margin-top: 1rem; margin-bottom: 0.5rem;">
                            <label class="checkbox-label"
                                style="font-weight: 500; display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" formControlName="isCreatingProvider"
                                    style="width: auto; height: 16px; margin: 0; cursor: pointer;">
                                Crear nuevo proveedor para todas estas herramientas
                            </label>
                        </div>
                    </div>

                    <!-- Use Existing Provider -->
                    <ng-container *ngIf="!batchForm.get('isCreatingProvider')?.value">
                        <div class="form-group full-width">
                            <label for="providerId">Seleccionar Proveedor Existente</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="providerId" formControlName="providerId" class="select-field"
                                    style="flex: 1;">
                                    <option value="" disabled selected>-- Elige un proveedor --</option>
                                    <option *ngFor="let p of providers" [value]="p.id">
                                        {{ p.name }} ({{ p.baseUrl }})
                                    </option>
                                </select>
                                <button type="button" class="btn secondary" *ngIf="batchForm.get('providerId')?.value"
                                    (click)="openEditProviderModal()"
                                    style="padding: 0.5rem 1rem; border-radius: 6px; display: flex; align-items: center; justify-content: center;"
                                    title="Editar Proveedor Seleccionado">‚úèÔ∏è</button>
                            </div>
                        </div>
                    </ng-container>

                    <!-- Create New Provider -->
                    <ng-container *ngIf="batchForm.get('isCreatingProvider')?.value">
                        <div class="form-group">
                            <label for="providerName">Nombre del Proveedor (Ej. OpenWeatherMap)</label>
                            <input id="providerName" type="text" formControlName="providerName"
                                placeholder="Ej. OpenWeatherMap API" />
                        </div>

                        <div class="form-group">
                            <label for="providerCode">C√≥digo √önico (Opcional)</label>
                            <input id="providerCode" type="text" formControlName="providerCode"
                                placeholder="Ej. owm-api" />
                        </div>

                        <div class="form-group full-width">
                            <label for="baseUrl">URL Base</label>
                            <input id="baseUrl" type="url" formControlName="baseUrl"
                                placeholder="Ej. https://api.weatherapi.com" />
                        </div>

                        <div class="form-group">
                            <label for="authenticationType">Tipo de Autenticaci√≥n</label>
                            <select id="authenticationType" formControlName="authenticationType">
                                <option value="NONE">Sin Autenticaci√≥n</option>
                                <option value="API_KEY">API Key</option>
                                <option value="BEARER_TOKEN">Bearer Token</option>
                                <option value="BASIC">Basic Auth</option>
                            </select>
                        </div>

                        <ng-container *ngIf="batchForm.get('authenticationType')?.value !== 'NONE'">
                            <div class="form-group">
                                <label for="apiKeyLocation">Ubicaci√≥n (API Key)</label>
                                <select id="apiKeyLocation" formControlName="apiKeyLocation">
                                    <option value="HEADER">Header</option>
                                    <option value="QUERY_PARAMETER">Query Parameter</option>
                                    <option value="IN_BODY">En Body (JSON)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="apiKeyName">Nombre de la clave</label>
                                <input id="apiKeyName" type="text" formControlName="apiKeyName"
                                    placeholder="Ej. Authorization / x-api-key" />
                            </div>
                            <div class="form-group">
                                <label for="apiKeyValue">Valor (Secreto)</label>
                                <input id="apiKeyValue" type="password" formControlName="apiKeyValue"
                                    placeholder="Valor del token" />
                            </div>
                        </ng-container>

                        <div class="form-group full-width" style="margin-top: 1rem;">
                            <details
                                style="background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 0.5rem 1rem;">
                                <summary style="cursor: pointer; font-weight: 500; outline: none; padding: 0.5rem 0;">
                                    Opciones Avanzadas (Custom Headers)
                                </summary>
                                <div
                                    style="margin-top: 0.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                                    <p class="helper-text" style="margin-bottom: 1rem;">Agrega headers personalizados
                                        adicionales para este proveedor que se enviar√°n en cada petici√≥n.</p>
                                    <button type="button" class="btn secondary" (click)="addCustomHeader()"
                                        style="margin-bottom: 1rem; padding: 0.4rem 0.8rem; font-size: 0.9rem;">+ A√±adir
                                        Header</button>

                                    <div formArrayName="customHeaders">
                                        <div *ngFor="let header of customHeaders.controls; let idx=index"
                                            [formGroupName]="idx"
                                            style="display: flex; gap: 10px; margin-bottom: 0.5rem; align-items: center;">
                                            <input type="text" formControlName="key"
                                                placeholder="Key (ej. X-Custom-Header)" style="flex: 1;">
                                            <input type="text" formControlName="value" placeholder="Value"
                                                style="flex: 1;">
                                            <button type="button" class="btn delete-btn"
                                                (click)="removeCustomHeader(idx)"
                                                style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                </div>
                            </details>
                        </div>
                    </ng-container>

                    <!-- Endpoints Section -->
                    <div class="form-group full-width section-title">
                        <div class="section-header">
                            <h3>2. Endpoints a Crear ({{ endpoints.length }})</h3>
                            <button type="button" class="btn secondary" (click)="addEndpoint()">+ A√±adir
                                Manualmente</button>
                        </div>
                    </div>

                    <div formArrayName="endpoints" class="full-width endpoints-list">
                        <div *ngFor="let ep of endpoints.controls; let i=index" [formGroupName]="i"
                            class="endpoint-card">
                            <div class="endpoint-header">
                                <select formControlName="httpMethod" class="method-badge"
                                    [ngClass]="ep.get('httpMethod')?.value" title="Cambiar M√©todo">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                    <option value="PATCH">PATCH</option>
                                </select>
                                <input type="text" formControlName="endpointPath" class="inline-input path-input"
                                    placeholder="Path ej. /v1/current.json">
                                <button type="button" class="btn delete-btn" (click)="removeEndpoint(i)"
                                    title="Eliminar endpoint">üóëÔ∏è</button>
                            </div>

                            <div class="endpoint-body">
                                <div class="form-group">
                                    <label>Nombre de la herramienta</label>
                                    <input type="text" formControlName="name" placeholder="Ej. Obtener Clima Actual">
                                </div>
                                <div class="form-group">
                                    <label>C√≥digo √önico (Opcional)</label>
                                    <input type="text" formControlName="code" placeholder="Ej. get-weather-current">
                                </div>
                                <div class="form-group full-width">
                                    <label>Descripci√≥n detallada</label>
                                    <textarea formControlName="description" rows="2"
                                        placeholder="Describe para qu√© sirve..."></textarea>
                                </div>

                                <!-- Endpoint Parameters -->
                                <div class="parameters-mini-list full-width">
                                    <div class="section-header-mini">
                                        <label>Par√°metros ({{ getParameters(i).length }})</label>
                                        <button type="button" class="btn small" (click)="addParameter(i)">+
                                            Param</button>
                                    </div>
                                    <div formArrayName="parameters">
                                        <div *ngFor="let param of getParameters(i).controls; let j=index"
                                            [formGroupName]="j" class="param-row-mini">
                                            <input type="text" formControlName="name" placeholder="Nombre (ej. q)"
                                                class="param-name">
                                            <select formControlName="type" class="param-type">
                                                <option value="STRING">String</option>
                                                <option value="NUMBER">Number</option>
                                                <option value="BOOLEAN">Boolean</option>
                                            </select>
                                            <label class="param-req"><input type="checkbox" formControlName="required">
                                                Req.</label>
                                            <button type="button" class="btn-text-danger"
                                                (click)="removeParameter(i, j)">√ó</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div *ngIf="endpoints.controls.length === 0" class="empty-state">
                            <p>No hay endpoints definidos. Importa un JSON de OpenAPI arriba o a√±ade uno manualmente.
                            </p>
                        </div>
                    </div>

                </div>

                <div class="form-actions">
                    <div *ngIf="successMessage" class="alert success">{{ successMessage }}</div>
                    <div *ngIf="errorMessage" class="alert error">{{ errorMessage }}</div>

                    <button type="button" class="btn ghost" routerLink="/home">Cancelar</button>
                    <button type="submit" class="btn primary" [disabled]="isSubmitting || endpoints.length === 0">
                        <span *ngIf="!isSubmitting">Guardar Todo</span>
                        <span *ngIf="isSubmitting">Guardando Batch...</span>
                    </button>
                </div>
            </form>
        </div>
    </main>

    @if (showEditProviderModal) {
    <div class="modal-overlay" (click)="closeEditProviderModal()">
        <div class="modal-content" (click)="$event.stopPropagation()"
            style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-top: 0; margin-bottom: 5px; font-size: 1.5rem;">Editar Proveedor</h3>
            <p style="text-align: left; margin-bottom: 1.5rem;">Modifica los detalles de conexi√≥n del proveedor.</p>

            <form [formGroup]="editProviderForm" (ngSubmit)="saveProviderChanges()">
                <div class="form-group">
                    <label for="editProviderName">Nombre del Proveedor</label>
                    <input id="editProviderName" type="text" formControlName="name" placeholder="Ej. Stripe API" />
                </div>

                <div class="form-group">
                    <label for="editProviderCode">C√≥digo √önico (Opcional)</label>
                    <input id="editProviderCode" type="text" formControlName="code" placeholder="Ej. stripe-api" />
                </div>

                <div class="form-group">
                    <label for="editBaseUrl">URL Base</label>
                    <input id="editBaseUrl" type="url" formControlName="baseUrl"
                        placeholder="Ej. https://api.stripe.com" />
                </div>

                <div class="form-group">
                    <label for="editAuthenticationType">Tipo de Autenticaci√≥n</label>
                    <select id="editAuthenticationType" formControlName="authenticationType">
                        <option value="NONE">Sin Autenticaci√≥n</option>
                        <option value="API_KEY">API Key</option>
                        <option value="BEARER_TOKEN">Bearer Token</option>
                        <option value="BASIC">Basic Auth</option>
                    </select>
                </div>

                <ng-container *ngIf="editProviderForm.get('authenticationType')?.value !== 'NONE'">
                    <div class="form-group">
                        <label for="editApiKeyLocation">Ubicaci√≥n (API Key)</label>
                        <select id="editApiKeyLocation" formControlName="apiKeyLocation">
                            <option value="HEADER">Header</option>
                            <option value="QUERY_PARAMETER">Query Parameter</option>
                            <option value="IN_BODY">En Body (JSON)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="editApiKeyName">Nombre de la clave</label>
                        <input id="editApiKeyName" type="text" formControlName="apiKeyName"
                            placeholder="Ej. Authorization / x-api-key" />
                    </div>

                    <div class="form-group full-width">
                        <label for="editApiKeyValue">Nuevo Valor del Secreto (En blanco para no cambiar)</label>
                        <input id="editApiKeyValue" type="password" formControlName="apiKeyValue"
                            placeholder="Nuevo valor del token" />
                    </div>
                </ng-container>

                <div class="form-group full-width" style="margin-top: 1rem;">
                    <details
                        style="background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 0.5rem 1rem;">
                        <summary style="cursor: pointer; font-weight: 500; outline: none; padding: 0.5rem 0;">
                            Opciones Avanzadas (Custom Headers)
                        </summary>
                        <div
                            style="margin-top: 0.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                            <p class="helper-text" style="margin-bottom: 1rem;">Agrega headers personalizados
                                adicionales para este proveedor que se enviar√°n en cada petici√≥n.</p>
                            <button type="button" class="btn secondary" (click)="addEditCustomHeader()"
                                style="margin-bottom: 1rem; padding: 0.4rem 0.8rem; font-size: 0.9rem;">+ A√±adir
                                Header</button>

                            <div formArrayName="customHeaders">
                                <div *ngFor="let header of editCustomHeaders.controls; let idx=index"
                                    [formGroupName]="idx"
                                    style="display: flex; gap: 10px; margin-bottom: 0.5rem; align-items: center;">
                                    <input type="text" formControlName="key" placeholder="Key (ej. X-Custom-Header)"
                                        style="flex: 1;">
                                    <input type="text" formControlName="value" placeholder="Value" style="flex: 1;">
                                    <button type="button" class="btn delete-btn" (click)="removeEditCustomHeader(idx)"
                                        style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    </details>
                </div>

                <div *ngIf="editProviderError" class="alert error" style="margin-top: 1rem;">
                    {{ editProviderError }}
                </div>

                <div class="form-actions"
                    style="margin-top: 2rem; justify-content: flex-end; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
                    <button type="button" class="btn ghost" (click)="closeEditProviderModal()"
                        [disabled]="isEditingProvider">Cancelar</button>
                    <button type="submit" class="btn primary"
                        [disabled]="editProviderForm.invalid || isEditingProvider">
                        <span *ngIf="!isEditingProvider">Guardar Cambios</span>
                        <span *ngIf="isEditingProvider">Guardando...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    }
</div>