<div class="container">
  <header>
    <div>
      <h1>HandsAI</h1>
      <p>IA como cerebro, HandsAI como sus manos</p>
    </div>
    <div style="display: flex; justify-content: center; margin-top: 1.5rem;">
      <button type="button" class="btn primary" (click)="openExportModal()"
        style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 1.2rem;">‚òÅÔ∏è</span> Exportar Herramientas
      </button>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- Stored Tools Section -->

      <div class="card">
        <div class="card-header">
          <h2>Herramientas Guardadas</h2>
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 0.8rem; color: #94a3b8;">üü¢ Activa &nbsp; ‚ö™ Inactiva</span>
            <span class="badge secondary">{{ storedTools.length }}</span>
          </div>
        </div>
        <p class="description">Todas las herramientas API registradas. Haz clic en una para editarla.</p>

        <div class="tool-list">
          @for (group of groupedStoredTools; track group.providerName) {
          <details class="provider-group"
            style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; margin-bottom: 15px; border: 1px solid rgba(255, 255, 255, 0.1);">
            <summary
              style="padding: 15px; cursor: pointer; font-weight: 600; font-size: 1.1rem; list-style: none; display: flex; align-items: center; justify-content: space-between;">
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 1.2rem;">üìÅ</span>
                {{ group.providerName }}
              </div>
              <span class="badge secondary" style="font-size: 0.8rem;">{{ group.tools.length }} herramientas</span>
            </summary>

            <div
              style="padding: 0 15px 15px 15px; display: flex; flex-direction: column; gap: 10px; border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 15px;">
              @for (tool of group.tools; track tool.id) {
              <div class="tool-item" style="cursor: pointer; margin: 0; background: rgba(0, 0, 0, 0.2);"
                (click)="openEditModal(tool)" title="Editar herramienta">
                <div class="tool-icon" [class.disabled]="!tool.enabled">
                  {{ tool.enabled ? 'üü¢' : '‚ö™' }}
                </div>
                <div class="tool-content">
                  <h3>{{ tool.name }}</h3>
                  <code class="tool-code">{{ tool.code }}</code>
                  <p>{{ tool.description }}</p>
                </div>
                <div class="tool-status" style="display: flex; align-items: center; gap: 10px;">
                  <span class="status-tag" [class.success]="tool.healthy" [class.error]="!tool.healthy">
                    {{ tool.healthy ? 'Healthy' : 'Unhealthy' }}
                  </span>
                  <button *ngIf="tool.id !== undefined" type="button" class="delete-btn"
                    (click)="deleteTool(tool.id, tool.name, $event)"
                    style="background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 0;"
                    title="Eliminar herramienta">üóëÔ∏è</button>
                </div>
              </div>
              }
            </div>
          </details>
          } @empty {
          <p class="empty-state">No hay herramientas registradas.</p>
          }
        </div>
      </div>
    </div>
  </main>

  <!-- Delete Confirmation Modal -->
  @if (showDeleteModal) {
  <div class="modal-overlay" (click)="closeDeleteModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>Confirmar Eliminaci√≥n</h3>
      <p>¬øEst√°s seguro de que deseas eliminar la herramienta <strong>{{ toolToDeleteName }}</strong>?</p>
      <div class="modal-actions">
        <button type="button" class="btn secondary" (click)="closeDeleteModal()">Cancelar</button>
        <button type="button" class="btn danger" (click)="confirmDelete()">Eliminar</button>
      </div>
    </div>
  </div>
  }

  <!-- Edit Tool Modal -->
  @if (showEditModal) {
  <div class="modal-overlay" (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()"
      style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
      <h3 style="margin-top: 0; margin-bottom: 5px; font-size: 1.5rem;">Editar Herramienta</h3>
      <p style="text-align: left; margin-bottom: 1.5rem;">Modifica los par√°metros de configuraci√≥n de esta herramienta.
      </p>

      <form [formGroup]="editForm" (ngSubmit)="saveEditChanges()">
        <div class="form-group">
          <label for="edit-name">Nombre <span style="color: #ef4444;">*</span></label>
          <input id="edit-name" type="text" formControlName="name" placeholder="Ej. Servicio de clima" />
          <div *ngIf="editForm.get('name')?.invalid && editForm.get('name')?.touched" class="error-msg">
            El nombre es requerido.
          </div>
        </div>

        <div class="form-group">
          <label for="edit-code">C√≥digo √önico (Opcional)</label>
          <input id="edit-code" type="text" formControlName="code" placeholder="Ej. api-clima" />
        </div>

        <div class="form-group">
          <label for="edit-description">Descripci√≥n <span style="color: #ef4444;">*</span></label>
          <textarea id="edit-description" formControlName="description" rows="3"
            placeholder="Describe qu√© hace esta herramienta..."></textarea>
          <div *ngIf="editForm.get('description')?.invalid && editForm.get('description')?.touched" class="error-msg">
            La descripci√≥n es requerida.
          </div>
        </div>

        <div class="form-group">
          <label for="edit-path">Endpoint Path <span style="color: #ef4444;">*</span></label>
          <input id="edit-path" type="text" formControlName="endpointPath" placeholder="Ej. /v1/current.json" />
          <div *ngIf="editForm.get('endpointPath')?.invalid && editForm.get('endpointPath')?.touched" class="error-msg">
            El path es requerido.
          </div>
        </div>

        <div class="form-group">
          <label for="edit-method">M√©todo HTTP <span style="color: #ef4444;">*</span></label>
          <select id="edit-method" formControlName="httpMethod">
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
            <option value="PATCH">PATCH</option>
          </select>
        </div>

        <div class="form-group checkbox-group" style="margin-top: 0.5rem; margin-bottom: 0.5rem;">
          <input id="edit-enabled" type="checkbox" formControlName="enabled" />
          <label for="edit-enabled">Habilitar esta herramienta para el agente activo</label>
        </div>

        <div class="form-group checkbox-group" style="margin-top: 0.5rem; margin-bottom: 1.5rem;">
          <input id="edit-isexportable" type="checkbox" formControlName="isExportable" />
          <label for="edit-isexportable">Hacer esta herramienta p√∫blica (Exportable)</label>
        </div>

        <!-- Parameters Section -->
        <div class="form-group full-width section-title" style="margin-top: 2rem;">
          <div class="section-header"
            style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.5rem; margin-bottom: 1rem;">
            <h4 style="margin: 0; font-size: 1.1rem; font-weight: 500;">Par√°metros</h4>
            <button type="button" class="btn secondary" (click)="addParameter()"
              style="padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.85rem;">+ A√±adir Par√°metro</button>
          </div>

          <div formArrayName="parameters" class="parameters-list"
            style="display: flex; flex-direction: column; gap: 1rem;">
            <div *ngFor="let param of parameters.controls; let i=index" [formGroupName]="i" class="parameter-row card"
              style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); padding: 1.25rem; border-radius: 8px; position: relative;">

              <button type="button" class="btn delete-btn" (click)="removeParameter(i)" title="Eliminar par√°metro"
                style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 0.2rem; display: flex; align-items: center; opacity: 0.7; transition: opacity 0.2s ease;">üóëÔ∏è</button>

              <div class="param-fields"
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; padding-right: 2rem;">
                <div class="form-group" style="margin: 0;">
                  <label style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 0.3rem;">Nombre <span
                      style="color: #ef4444;">*</span></label>
                  <input type="text" formControlName="name" placeholder="Ej. q"
                    style="padding: 0.6rem; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.15); background: rgba(0, 0, 0, 0.2);">
                </div>

                <div class="form-group" style="margin: 0;">
                  <label style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 0.3rem;">Tipo <span
                      style="color: #ef4444;">*</span></label>
                  <select formControlName="type"
                    style="padding: 0.6rem; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.15); background: rgba(0, 0, 0, 0.2);">
                    <option value="STRING">String</option>
                    <option value="NUMBER">Number</option>
                    <option value="BOOLEAN">Boolean</option>
                  </select>
                </div>

                <div class="form-group full-width" style="grid-column: 1 / -1; margin: 0;">
                  <label style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 0.3rem;">Descripci√≥n
                    <span style="color: #ef4444;">*</span></label>
                  <input type="text" formControlName="description" placeholder="Ej. Nombre de la ciudad"
                    style="padding: 0.6rem; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.15); background: rgba(0, 0, 0, 0.2);">
                </div>

                <div class="form-group checkbox-group" style="grid-column: 1 / -1; margin: 0; padding-top: 0.5rem;">
                  <input type="checkbox" [id]="'edit-required-'+i" formControlName="required" />
                  <label [for]="'edit-required-'+i">Requerido</label>
                </div>
              </div>
            </div>

            <div *ngIf="parameters.controls.length === 0" class="empty-state"
              style="text-align: center; padding: 2rem 1rem; background: rgba(0,0,0,0.2); border-radius: 8px; border: 1px dashed rgba(255,255,255,0.2);">
              <p style="margin: 0; color: rgba(255,255,255,0.6); font-size: 0.9rem;">Esta herramienta no tiene
                par√°metros definidos.</p>
            </div>
          </div>
        </div>

        <div *ngIf="error" class="alert error" style="margin-top: 15px;">{{ error }}</div>

        <div class="modal-actions">
          <button type="button" class="btn secondary" (click)="closeEditModal()">Cancelar</button>
          <button type="submit" class="btn primary" [disabled]="isSubmittingEdit || editForm.invalid">
            <span *ngIf="!isSubmittingEdit">Guardar Cambios</span>
            <span *ngIf="isSubmittingEdit">Guardando...</span>
          </button>
        </div>
      </form>
    </div>
  </div>
  }
  <!-- Export Modal -->
  @if (showExportModal) {
  <div class="modal-overlay" (click)="closeExportModal()">
    <div class="modal-content" (click)="$event.stopPropagation()"
      style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
      <h3 style="margin-top: 0; margin-bottom: 5px; font-size: 1.5rem;">Exportar Herramientas P√∫blicas</h3>
      <p style="text-align: left; margin-bottom: 1.5rem;">Crea un archivo JSON con los proveedores y herramientas
        exportables para compartir con otros agentes y plataformas.</p>

      <div
        style="background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
        <div
          style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.5rem;">
          <h4 style="margin: 0;">Proveedores Disponibles ({{exportableProviders.length}})</h4>
          <button type="button" class="btn secondary" (click)="selectAllExport()"
            style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
            {{ selectedExportIds.size === exportableProviders.length ? 'Desmarcar Todos' : 'Seleccionar Todos' }}
          </button>
        </div>

        @if (exportableProviders.length === 0) {
        <p style="text-align: center; color: rgba(255,255,255,0.5); font-style: italic;">No hay herramientas p√∫blicas
          disponibles para exportar.</p>
        } @else {
        <div
          style="display: flex; flex-direction: column; gap: 0.8rem; max-height: 300px; overflow-y: auto; padding-right: 0.5rem;">
          @for (provider of exportableProviders; track provider.name; let idx = $index) {
          <div class="card"
            style="padding: 1rem; cursor: pointer; border: 1px solid rgba(255,255,255,0.05); transition: background-color 0.2s;"
            [style.background]="selectedExportIds.has(idx) ? 'rgba(0, 168, 255, 0.1)' : 'rgba(255, 255, 255, 0.03)'"
            (click)="toggleExportSelection(idx)">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <div>
                <h5 style="margin: 0; font-size: 1rem;">{{provider.name}}</h5>
                <p style="margin: 0.3rem 0 0; font-size: 0.85rem; color: rgba(255,255,255,0.6);">{{provider.baseUrl}} ‚Ä¢
                  {{provider.tools.length}} herramientas</p>
              </div>
              <div
                style="width: 24px; height: 24px; border-radius: 4px; border: 2px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center;"
                [style.background]="selectedExportIds.has(idx) ? '#00a8ff' : 'transparent'">
                <span *ngIf="selectedExportIds.has(idx)" style="color: white; font-weight: bold;">‚úì</span>
              </div>
            </div>
          </div>
          }
        </div>
        }
      </div>

      <div class="modal-actions" style="margin-top: 2rem;">
        <button type="button" class="btn text-btn" (click)="closeExportModal()">Cancelar</button>
        <button type="button" class="btn primary" (click)="exportSelectedProviders()"
          [disabled]="isExporting || exportableProviders.length === 0">
          <span *ngIf="!isExporting">Descargar JSON ({{ selectedExportIds.size > 0 ? selectedExportIds.size : 'Todos
            los' }} proveedores)</span>
          <span *ngIf="isExporting">Generando...</span>
        </button>
      </div>
    </div>
  </div>
  }
</div>